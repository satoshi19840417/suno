# スキル使用忘れ再発防止策：AGENTS.md ルール強化プラン

## Context（背景）

### 発生した問題
ユーザーが「sora2でプロンプト案を提案して」とリクエストした際、クイックルーティング表に明確に記載されている `propose-sora-prompts` スキルを使用せず、直接回答してしまった。

### 問題の根本原因
- スキル使用判定のプロセスが曖昧で、思考漏れが発生しやすい
- クイックルーティング表との照合が形式的に行われていない
- 複数候補がある場合の優先順位ルールが不明確
- スキル使用違反を検出・修正するメカニズムが不足

### 改善の目的
AGENTS.mdのルールを強化し、以下を実現する：
1. **スキル使用判定を構造化・明確化**（注：完全な自動化ではなく、文書ベースの構造的防止）
2. 判定プロセスを段階的チェックリスト化して思考漏れを防止
3. 曖昧なケースの判定ロジックを明文化（スキル非該当ケースの判定基準を含む）
4. 違反検出と自己修正フローを確立

---

## Implementation Plan（実装計画）

### 実装順序（重要）

以下の順序で実施することで、セクション参照の衝突を回避します：

**ステップ1: 新セクションの追加**
- 1.2 「あいまいな場合の判定ロジック」をクイックルーティング表の直後に挿入
- 1.3 「スキル使用忘れ自己診断チェックリスト」を1.2の直後に挿入
- 1.5 「スキル使用違反の自己修正フロー」を1.3の直後に挿入

**ステップ2: クイックルーティング表の置き換え**
- 1.4 既存の「クイックルーティング表」をGroup分類版に全面置き換え

**ステップ3: CRITICALセクションの全面改訂**
- 1.1 「CRITICAL: スキルチェック義務」セクションを新しい3段階チェック版に全面置き換え
- この時点で、新セクション（1.2, 1.3, 1.5）への参照が有効になる

**衝突回避の理由**: ステップ3で「CRITICALセクション全体置き換え」を先に実行すると、クイックルーティング表が消失し、ステップ1での「クイックルーティング表の直後」への挿入が失敗する可能性があるため、この順序を厳守すること。

---

### Phase 1: AGENTS.mdの構造改善

#### 1.1 「CRITICAL: スキルチェック義務」セクションの全面改訂（ステップ3で実施）

**現在の問題:**
- 3ステップは記載されているが、実行の強制力が弱い
- 各ステップの詳細な判定基準が不明確

**改善内容:**
以下の構造に書き換える：

```markdown
## CRITICAL: スキルチェック義務（最優先ルール）

**必ず実行する3段階チェック（順序厳格）:**

### ステップ1: リクエスト解析（ユーザー発話から情報抽出）
- 【必須確認】キーワード、アクション、コンテキストを抽出
  - キーワード例：「提案」「作成」「起動」「終了」など
  - アクション例：複数案提示、単一案生成、実行、同期など
  - コンテキスト例：明確なビジョン有無、段階、制約条件

### ステップ2: スキルマッピング（クイックルーティング表を使用）
- 【必須参照】下記のクイックルーティング表で該当スキルを検索
- 【自動判定ルール】以下の優先順で判定：
  1. キーワードが表の「ユーザーの発話パターン」に完全一致 → マッチ
  2. キーワードが部分一致 → セクション「あいまいな場合の判定ロジック」参照
  3. 複数スキルが候補 → セクション「あいまいな場合の判定ロジック > ケース3」参照

### ステップ3: スキル実行判定（最終確認）
- 【実行条件】いずれかのスキルがマッチした場合 → **必ずスキルを使用**
- 【禁止事項】以下の行為は厳禁：
  - マッチしたスキルを無視して直接回答
  - 正当な理由なく「スキルは適用外」と判定
  - スキル実行をスキップして「参考情報」として提示

- 【スキル非該当の判定基準と優先順位】以下の順序で厳格に評価：

  **1. 明確な非該当条件（以下いずれかに該当する場合のみスキップ可能）:**

  **パターンA**: 該当スキルなし
  - ステップ2で該当スキルが0件（クイックルーティング表に該当なし）
  - かつ、リクエストが純粋な情報照会・説明要求で、生成・実行アクションを含まない

  **パターンB**: 誤マッチ
  - SKILL.mdの「使用場面」と明確に矛盾する（例：技術的質問なのに動画生成スキルがマッチ）
  - かつ、リクエストが純粋な情報照会・説明要求で、生成・実行アクションを含まない

  **論理式**: (パターンA) OR (パターンB) の場合のみスキップ可能

  **2. 判定が曖昧な場合の優先ルール:**
  - 上記の非該当条件に「明確に該当する」と言い切れない場合 → **スキル使用する**
  - 「スキル使用すべきか迷う」場合 → **スキル使用する**
  - 「非該当かもしれないが確信がない」場合 → **スキル使用する**

  **判定の原則**: 疑わしきはスキル使用。非該当と判定するには明確な根拠が必要。

【違反検出】回答を生成する直前に、必ず以下を確認：
- □ ステップ1～3を実行したか？
- □ スキルマッチの判定結果を記録したか？（記録先：**回答冒頭に必須記載**）
- □ マッチしたスキルがあるなら、その SKILL.md を読んだか？
- □ 回答冒頭に「使用スキル: [スキル名]」と明記したか？

**記録の必須要件**: スキルを使用する場合、回答の最初の行に必ず「【使用スキル】[スキル名]」と明記すること。これにより監査と検証が可能になる。

いずれかが欠けている場合、回答生成を中断し、欠けたステップを実行してから再開すること。
```

**実装方法:** AGENTS.mdの「## CRITICAL: スキルチェック義務（最優先ルール）」セクション全体を上記内容に置き換える

**Critical file:** `c:\Users\sench\remotion-test-work\AGENTS.md`

---

#### 1.2 新セクション「あいまいな場合の判定ロジック」を追加

**挿入位置:** クイックルーティング表の直後

**内容:**
````markdown
## あいまいな場合の判定ロジック

スキルマッピングがあいまいな場合、以下の優先度で判定:

### ケース1: キーワード部分一致が複数ある場合

**例**: ユーザー「Sora2の映像のアイデアをいくつか出して」
- マッチ候補: `propose-sora-prompts` (「複数案」「アイデア」)
- アクション: 「複数案の提示」
- **判定**: `propose-sora-prompts` を使用 ✓

**例**: ユーザー「1つのプロンプトを作ってください」
- マッチ候補: `create_sora_prompt` (「プロンプト」「作成」)
- アクション: 「単一案の生成」
- **判定**: `create_sora_prompt` を使用 ✓

### ケース2: 文脈的に明確なビジョンがある/ない

**迷った場合のチェック:**
```text
Q1: ユーザーは「複数の選択肢を見たい」か「1つの完成品を作りたい」か？
  → 複数選択肢 → `propose-sora-prompts`
  → 1つの完成品 → `create_sora_prompt`

Q2: ユーザーのコンセプトの説明量は？
  → 詳細・具体的 → 単一生成系スキル使用
  → ざっくり・抽象的 → 複数提案系スキルを検討
```

### ケース3: 複数スキルが同時に候補になった場合

**優先順位ルール**（上から順に評価）:
1. ユーザーの発話に「複数」「案」「いくつか」などの複数性キーワードがあるか
   → YES → 複数提案型スキル (`propose-*`) 優先
2. ユーザーが「この方向で作ってほしい」と方向性を指定しているか
   → YES → 単一生成型スキル (`create_*`) 優先
3. 迷った場合は「複数案の提示→選択→詳細化」の流れで、ユーザーに選択権を与えるスキルを優先
   → `propose-*` スキルの方針に従う

### ケース4: 日本映画調など特定スタイルの指定がある場合

**判定**:
- 「日本映画調」「感情的シーン」「5段階ワークフロー」 → `sora2-japan-cinematic-prompts`
- バイリンガル出力要件がある → `sora2-prompt-bilingual`

**優先適用**: より具体的な制約条件を持つスキルを優先
````

**実装方法:** AGENTS.mdの「### クイックルーティング表」セクションの直後に新セクションとして挿入

**Critical file:** `c:\Users\sench\remotion-test-work\AGENTS.md`

---

#### 1.3 新セクション「スキル使用忘れ自己診断チェックリスト」を追加

**挿入位置:** 「あいまいな場合の判定ロジック」の後

**内容:**
```markdown
## スキル使用忘れ自己診断チェックリスト

回答を生成する前に、以下のチェックリストを実行し、すべてにチェックが入っているか確認:

### 段階1: リクエスト解析チェック
- [ ] ユーザーの発話から「キーワード」を抽出した
- [ ] 「アクション」（何をしてほしいのか）を明確にした
- [ ] 「ビジョンの明確性」（具体的 vs 抽象的）を判定した
- [ ] 「複数性」（複数案 vs 単一案）を判定した

### 段階2: スキルマッピングチェック
- [ ] クイックルーティング表を参照した
- [ ] 該当する行を少なくとも1つ特定した
- [ ] 複数候補がある場合、優先順位ルールで絞った
- [ ] 最終的なスキル候補を明確に記録した
  - **記録先**: **回答冒頭の「使用スキル」欄に必須記載**（監査可能性のため外部記録を必須化）
  - **記録形式**: 回答の最初の行に「【使用スキル】[スキル名]」
  - **補足記録**: 必要に応じて「抽出キーワード: [キーワード]」を追記可能
  - **責任**: 回答生成者（エージェント自身）

### 段階3: スキル実行判定チェック
- [ ] スキル候補がある場合、その SKILL.md を読んだ
- [ ] 現在のリクエストがそのスキルの「使用場面」に合致するか確認した
- [ ] スキル実行に必要な情報がすべて揃っているか確認した
- [ ] スキル実行を中止する正当な理由がないか確認した

### 段階4: 回答生成チェック
- [ ] 回答の冒頭に「使用スキル: [スキル名]」と明記した
- [ ] 複数スキルがある場合、実行順序を明示した
- [ ] スキルのワークフローに従って進めた
- [ ] スキル使用なしで直接回答していないか

**すべてチェック入ったか？**
- YES → そのまま進める
- NO → 欠けたステップを実行してから回答生成
```

**実装方法:** AGENTS.mdの「## あいまいな場合の判定ロジック」セクションの直後に新セクションとして挿入

**Critical file:** `c:\Users\sench\remotion-test-work\AGENTS.md`

---

#### 1.4 クイックルーティング表のGroup分類化

**現在の問題:**
- 8パターンのみで、類似スキルの差別化が不明確
- 判定根拠が記載されていない

**改善内容:**
現在のクイックルーティング表を以下のGroup分類版に置き換える：

```markdown
### クイックルーティング表（ユーザー発話 → スキル）

#### Group A: Sora2 プロンプト生成（複数案提示型）
| 発話パターン | キーワード | 使用スキル | 判定根拠 |
|---|---|---|---|
| 「プロンプト案を提案」「アイデアが欲しい」「複数案出して」 | 複数, 案, アイデア | `propose-sora-prompts` | 複数性キーワード + 提案アクション |
| 「Sora2のアイデアをいくつか」「方向性が迷ってる」 | 複数, 方向性, 迷い | `propose-sora-prompts` | 意思決定支援の需要 |

#### Group B: Sora2 プロンプト生成（単一案生成型）
| 発話パターン | キーワード | 使用スキル | 判定根拠 |
|---|---|---|---|
| 「プロンプトを作って」「1案作成」（明確なビジョンあり） | 作成, 作って, ビジョン明確 | `create_sora_prompt` | 単一生成 + ビジョン具体的 |
| 「このコンセプトでSora2プロンプト作成」（詳細説明付き） | 詳細説明, 作成, コンセプト | `create_sora_prompt` | 具体的要件の充実 |

#### Group C: Sora2 プロンプト生成（特定スタイル）
| 発話パターン | キーワード | 使用スキル | 判定根拠 |
|---|---|---|---|
| 「日本映画調」「感情的シーン」「5段階ワークフロー」 | 日本, 映画, 感情, 構造化 | `sora2-japan-cinematic-prompts` | スタイル + 構造化要件 |
| 「バイリンガル出力」「英語と日本語で」 | バイリンガル, 英語, 日本語 | `sora2-prompt-bilingual` | 言語要件 |

#### Group D: リリック動画生成
| 発話パターン | キーワード | 使用スキル | 判定根拠 |
|---|---|---|---|
| 「リリック動画作って」「歌詞動画」「Remotionで歌詞」 | リリック, 歌詞, 動画 | `create_lyric_video` | 歌詞ベース動画 |
| 「縦書きリリック」「縦書き歌詞動画」 | 縦書き, リリック | `create_vertical_lyric_video` | 特定フォーマット要件 |

#### Group E: 開発・実行
| 発話パターン | キーワード | 使用スキル | 判定根拠 |
|---|---|---|---|
| 「開発環境起動」「プレビュー見たい」「Remotion起動」 | 起動, プレビュー, 環境 | `remotion-preview-launch` | 実行環境制御 |
| 「作業終了」「GitHubにpush」「同期」 | 終了, 完了, GitHub, push | `finish_work` | 終了・同期処理 |

#### Group F: スキル・開発
| 発話パターン | キーワード | 使用スキル | 判定根拠 |
|---|---|---|---|
| 「スキル作って」「スキル更新」「新しい機能作成」 | スキル, 作成, 新機能 | `skill-creator` / `skill-authoring-guidelines` | スキル開発 |
```

**実装方法:** AGENTS.mdの「### クイックルーティング表（ユーザー発話 → スキル）」セクション全体を上記のGroup分類版テーブルに置き換える

**Critical file:** `c:\Users\sench\remotion-test-work\AGENTS.md`

---

#### 1.5 新セクション「スキル使用違反の自己修正フロー」を追加

**挿入位置:** チェックリストの後

**内容:**
````markdown
## スキル使用違反の自己修正フロー

もし、生成途中や生成後に「スキルを使うべきだった」と気づいた場合の対応:

### 違反パターン認識

**以下のいずれかに当てはまれば、スキル使用忘れの可能性が高い:**
- クイックルーティング表に明確に該当するキーワードが発話に含まれている
- 「複数案を見たい」というニーズが隠れているのに単一案を提示している
- スキル説明の「使用場面」そのものなのに直接回答している
- 本来複数段階ワークフロー（案提示→選択→詳細化）なのに1段階で終わっている

### 自己修正ステップ

**Step 1: 違反確認**
- 現在の回答で、該当するスキルがあるか確認
- クイックルーティング表で明確にマッチしているか再検証

**Step 2: 修正判定**
- 修正対象のスキルを明確にする
- 現在の回答をスキルワークフローに従い再構成できるか確認

**Step 3: ユーザー通知と修正**
```text
申し訳ありません。ご質問は「[スキル名]」を使うべきでした。
以下、適切なワークフローで改めて対応します：

【使用スキル】[スキル名]
[スキルのワークフローに従い、改めて回答]
```

**Step 4: 二度と繰り返さない**
- 同じパターンでの失敗を記録
- 今後のスキルマッピングに反映
````

**実装方法:** AGENTS.mdの「## スキル使用忘れ自己診断チェックリスト」セクションの直後に新セクションとして挿入

**Critical file:** `c:\Users\sench\remotion-test-work\AGENTS.md`

---

### Phase 2: CLAUDE.md との整合性確認

**現状:**
CLAUDE.mdには「Skill-First Rule（最優先）」として、AGENTS.mdを参照するよう簡潔に記載されている。

**対応:**
- CLAUDE.mdは現状維持（簡潔な参照として機能している）
- AGENTS.mdが詳細なルールを保持する構造を維持

**Critical files:**
- `c:\Users\sench\remotion-test-work\AGENTS.md` (詳細ルール)
- `c:\Users\sench\remotion-test-work\my-remotion-01\CLAUDE.md` (簡潔な参照)

---

### Phase 3: スキル定義の検証

以下のスキルの「使用場面」が判定ロジックと整合しているか確認：

**検証対象:**
1. `propose-sora-prompts` - 複数案提示型
   - パス: `my-remotion-01\.agent\skills\propose-sora-prompts\SKILL.md`
   - 使用場面：アイデア探索、複数アプローチの比較、演出方向の決定
   - 判定根拠との整合性：✓ 明確

2. `create_sora_prompt` - 単一生成型
   - パス: `my-remotion-01\.agent\skills\create_sora_prompt\SKILL.md`
   - 使用場面：明確なビジョンがある場合、1案の直接生成
   - 判定根拠との整合性：✓ 明確

3. `sora2-japan-cinematic-prompts` - 特定スタイル
   - パス: `.agents\skills\sora2-japan-cinematic-prompts\SKILL.md` (注：`.agents`は複数形)
   - 使用場面：日本映画調、感情的シーン、5段階ワークフロー
   - 判定根拠との整合性：✓ 明確

**結論:** 現在のスキル定義は判定ロジックと整合している。追加修正は不要。

**Critical files:**
- `c:\Users\sench\remotion-test-work\my-remotion-01\.agent\skills\propose-sora-prompts\SKILL.md`
- `c:\Users\sench\remotion-test-work\my-remotion-01\.agent\skills\create_sora_prompt\SKILL.md`
- `c:\Users\sench\remotion-test-work\.agents\skills\sora2-japan-cinematic-prompts\SKILL.md`

---

## Verification（検証方法）

### 1. ルール強化の検証
改善後のAGENTS.mdを読み、以下をシミュレーション：
- ユーザー発話：「Sora2でプロンプト案を提案して」
- ステップ1：キーワード抽出 → 「提案」「案」
- ステップ2：クイックルーティング表参照 → Group A, `propose-sora-prompts` にマッチ
- ステップ3：SKILL.mdを読み、使用場面と一致を確認
- 期待結果：`propose-sora-prompts` スキルを使用し、複数案提示→選択→詳細化のワークフローに従う

### 2. チェックリストの検証
回答生成前にチェックリストの各項目を実行：
- 段階1～4の全項目にチェックが入るか確認
- チェック漏れがある場合、該当ステップを実行
- 期待結果：スキル該当ケースで使用忘れがゼロになる
  - **測定基準**: 10件のテストケース（スキル該当5件、非該当5件）で100%正確な判定

### 3. 自己修正フローの検証
意図的にスキルを使わずに回答を生成し：
- 違反パターン認識が機能するか確認
- 自己修正ステップに従い、適切な修正が行われるか確認
- 期待結果：違反を検出し、正しいスキルで再回答できる

### 4. 曖昧ケースの判定検証（ハッピーパス）
以下のケースで判定ロジックをテスト：
- 「Sora2のアイデアをいくつか出して」 → `propose-sora-prompts`
- 「1つのプロンプトを作って」 → `create_sora_prompt`
- 「日本映画調で」 → `sora2-japan-cinematic-prompts`
- 期待結果：すべて正しいスキルにマッピングされる

### 5. スキル非該当ケースの判定検証（ネガティブケース）
以下のケースでスキル非使用判定が正しく機能するか確認：
- 「propose-sora-promptsスキルとは何ですか？」 → スキル非使用（情報照会）
- 「Sora2の技術仕様を教えて」 → スキル非使用（説明要求）
- 「Remotionのバージョンを確認して」 → スキル非使用（技術的問合せ）
- 期待結果：スキル非該当と正しく判定され、直接回答する

### 6. 誤マッチ防止の検証
以下のケースで誤ったスキル適用を防止できるか確認：
- 「Sora2について調べて」 → スキル候補はあるが、SKILL.mdの「使用場面」と矛盾するため非使用
- 「プロンプトという単語の意味は？」 → キーワードマッチするが、生成アクションがないため非使用
- 期待結果：誤適用を防止し、適切に直接回答する

---

## Critical Files

### 変更対象ファイル
- `c:\Users\sench\remotion-test-work\AGENTS.md` - メインのルール強化対象

### 参照ファイル（変更なし）
- `c:\Users\sench\remotion-test-work\my-remotion-01\CLAUDE.md` - Skill-First Ruleの簡潔版
- `c:\Users\sench\remotion-test-work\my-remotion-01\.agent\skills\propose-sora-prompts\SKILL.md` - 複数案提示型の定義確認用
- `c:\Users\sench\remotion-test-work\my-remotion-01\.agent\skills\create_sora_prompt\SKILL.md` - 単一生成型の定義確認用

---

## Expected Impact（期待される効果）

1. **思考漏れの防止**: 段階的チェックリストにより、スキル使用判定の思考プロセスを構造化
2. **判定の明確化と構造化**: 明確な判定ロジックにより、曖昧なケースでも正確なマッピングが可能（注：完全な自動化ではなく、文書ベースのガイドライン強化）
3. **違反の早期検出**: 自己修正フローにより、違反を検出し即座に修正
4. **保守性の向上**: Group分類により、新スキル追加時の整理が容易
5. **スキル非該当ケースの適切な処理**: 誤適用を防止し、情報照会や説明要求に対して適切に直接回答

---

## Implementation Notes

- すべての改善は `AGENTS.md` の既存構造を拡張する形で実施
- 既存のスキル定義（SKILL.md）は変更不要
- CLAUDE.mdとの整合性は維持
- 改善後は、実際のユーザーリクエストでテストし、効果を検証

### 重要な制約
1. **文書ベースの改善**: 本プランは文書（AGENTS.md）の改善であり、技術的な自動検出・強制メカニズムの実装は含まない
2. **判定の最終責任**: スキル使用の判定は最終的にエージェント自身の思考プロセスに依存する
3. **段階的な改善**: チェックリストや判定ロジックは、使用しながら継続的に改善する必要がある
